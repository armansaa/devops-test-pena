name: Deploy to VM

on:
  push:
    branches: [main]

jobs:
  deploy:
    if: contains(github.event.head_commit.message, 'deploy_vm') || contains(github.event.head_commit.message, 'deploy_all')
    runs-on: ubuntu-latest
    steps:
    - name: Deploy via Ansible on VM1
      uses: appleboy/ssh-action@v1.0.3
      with:
        command_timeout: 30m
        host: ${{ secrets.VM1_SSH_HOST }}
        username: ${{ secrets.VM1_SSH_USER }}
        key: ${{ secrets.VM1_SSH_PRIVATE_KEY }}
        script: |
          set -euo pipefail

            # -------- Variables (dynamic user from secret)
            SSH_USER="${{ secrets.VM1_SSH_USER }}"
            BASE_DIR="/home/${SSH_USER}/projects"
            REPO_NAME="devops-test-pena"
            REPO_DIR="${BASE_DIR}/${REPO_NAME}"
            REPO_URL="https://github.com/${{ github.repository }}.git"

            echo "[INFO] Running as: $(whoami)"
            echo "[INFO] HOME: ${HOME}"
            echo "[INFO] BASE_DIR: ${BASE_DIR}"
            echo "[INFO] REPO_DIR: ${REPO_DIR}"
            echo "[INFO] REPO_URL: ${REPO_URL}"

            # -------- Ensure base directory exists
            mkdir -p "${BASE_DIR}"

            # -------- Clone or update repository
            if [ ! -d "${REPO_DIR}/.git" ]; then
              echo "[INFO] Repo not found, cloning..."
              git clone --depth 1 "${REPO_URL}" "${REPO_DIR}"
            else
              echo "[INFO] Repo exists, updating..."
              cd "${REPO_DIR}"
              git fetch --all --prune
              git reset --hard origin/main
            fi

            # -------- Sanity checks
            cd "${REPO_DIR}"
            echo "[INFO] Repo content:"
            ls -la

            if [ ! -d "ansible" ]; then
              echo "[ERROR] Folder 'ansible/' tidak ditemukan di root repo."
              exit 1
            fi

            if [ ! -f "ansible/playbooks/deploy.yml" ]; then
              echo "[ERROR] Playbook 'ansible/playbooks/deploy.yml' tidak ditemukan."
              echo "[INFO] Isi ansible/playbooks:"
              ls -la ansible/playbooks || true
              exit 1
            fi

            # -------- Run ansible
            cd ansible
            echo "[INFO] Ansible version:"
            ansible --version

            echo "[INFO] Running playbook..."
            ansible-playbook playbooks/deploy.yml
