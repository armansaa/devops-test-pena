name: Deploy to VM

on:
  push:
    branches: [main]
    paths:
      - "app/**"
      - "ansible/**"
      - ".github/workflows/deploy-vm.yml"

jobs:
  deploy:
    if: contains(github.event.head_commit.message, 'deploy_vm') || contains(github.event.head_commit.message, 'deploy_all')
    runs-on: ubuntu-latest
    steps:
    - name: Deploy via Ansible on VM1
      uses: appleboy/ssh-action@v1.0.3
      with:
        command_timeout: 30m
        host: ${{ secrets.VM1_SSH_HOST }}
        username: ${{ secrets.VM1_SSH_USER }}
        key: ${{ secrets.VM1_SSH_PRIVATE_KEY }}
        script: |
          set -euo pipefail

          # -------- Variables (dynamic user from secret)
          SSH_USER="${{ secrets.VM1_SSH_USER }}"
          BASE_DIR="/home/${SSH_USER}/projects"
          REPO_NAME="${{ github.event.repository.name }}"
          REPO_DIR="${BASE_DIR}/${REPO_NAME}"
          REPO_URL="https://github.com/${{ github.repository }}.git"

          echo "[INFO] Running as: $(whoami)"
          echo "[INFO] HOME: ${HOME}"
          echo "[INFO] BASE_DIR: ${BASE_DIR}"
          echo "[INFO] REPO_DIR: ${REPO_DIR}"
          echo "[INFO] REPO_URL: ${REPO_URL}"

          # -------- Ensure base directory exists
          mkdir -p "${BASE_DIR}"

          # -------- Clone or update repository
          if [ ! -d "${REPO_DIR}/.git" ]; then
            echo "[INFO] Repo not found, cloning..."
            git clone --depth 1 "${REPO_URL}" "${REPO_DIR}"
          else
            echo "[INFO] Repo exists, updating..."
            git -C "${REPO_DIR}" fetch --all --prune
            git -C "${REPO_DIR}" reset --hard origin/main
          fi

          # -------- Sanity checks
          echo "[INFO] Repo content:"
          ls -la "${REPO_DIR}"

          if [ ! -d "${REPO_DIR}/ansible" ] || [ ! -f "${REPO_DIR}/ansible/playbooks/deploy.yml" ]; then
            echo "[ERROR] Folder 'ansible/' atau playbook tidak ditemukan di ${REPO_DIR}."
            echo "[INFO] Isi ${REPO_DIR}:"
            ls -la "${REPO_DIR}" || true
            echo "[INFO] Isi ${REPO_DIR}/ansible:"
            ls -la "${REPO_DIR}/ansible" || true
            echo "[INFO] Isi ${REPO_DIR}/ansible/playbooks:"
            ls -la "${REPO_DIR}/ansible/playbooks" || true
            exit 1
          fi

          # -------- Run ansible
          cd "${REPO_DIR}/ansible"
          echo "[INFO] Ansible version:"
          ansible --version

          echo "[INFO] Running playbook..."
          ansible-playbook playbooks/deploy.yml -e "app_repo=${REPO_URL}"
